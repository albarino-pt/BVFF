---
import DefaultLayout from "../layouts/DefaultLayout.astro";
import PageHeader from "../components/PageHeader.astro";
import { viaturas } from "../data/viaturas";
import ViaturaCard from "../components/ViaturaCard.astro";
---

<DefaultLayout title="Verificação Viaturas">
  <section class="mt-20">
    <div class="container">
      <h1>Verificação Viaturas (mecânica e sinalização)</h1>
    </div>
  </section>
  <section class="my-12">
    <div class="space-content container">
      <p class="text-xl">
        Complete as verificações abaixo para garantir a operabilidade da
        viatura.
      </p>

      <div></div>
      <section class="my-12">
        <!-- <PageHeader
      title="Verificação Viaturas (mecânica e sinalização)"
      subtitle="Complete as verificações abaixo para garantir a operabilidade da viatura."
      bgType="bordered"
    /> -->
      </section>

      <section class="mt-32 mb-12">
        <form id="checklist-form" class="container space-y-6">
          <!-- Viatura Info -->
          <div class="space-y-4 rounded-md  p-4 shadow-sm">
            <h3 class="text-lg font-semibold">Identificação</h3>

            <!-- Número Operacional -->
            <label class="block text-lg font-semibold "
              >Número Operacional</label
            >
            <input
              type="number"
              name="operacional"
              placeholder="Insira o número operacional"
              class="w-full rounded-md border p-2"
              required
            />

            <!-- PIN -->
            <label class="block text-lg font-semibold "
              >Código de Autenticação</label
            >
            <input
              type="password"
              name="pin"
              placeholder="Código de 4 dígitos"
              class="w-full rounded-md border p-2"
              required
            />

            <!-- Viatura Selection -->
            <label class="block text-lg font-semibold "
              >Selecione a viatura</label
            >
            <input type="hidden" name="viatura" id="viatura-input" />
            <div
              class="mx-auto grid max-w-screen-lg grid-cols-2 gap-4 px-4 py-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6"
            >
              {
                viaturas.map((v) => (
                  <ViaturaCard name={v.name} plate={v.plate} />
                ))
              }
            </div>
          </div>

          <!-- Mecânica -->
          <div class="space-y-4 rounded-md  p-4 shadow-sm">
            <h3 class="text-lg font-semibold">Verificação Mecânica</h3>

            <div class="space-y-4">
              <!-- Óleo -->
              <div>
                <label class="mb-2 block text-lg font-semibold "
                  >Óleo</label
                >
                <div class="flex flex-wrap gap-2">
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="oleo"
                      value="true"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                    >
                      Nivel Ok
                    </div>
                  </label>
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="oleo"
                      value="false"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-red-500 peer-checked:text-white"
                    >
                      Nivel baixo
                    </div>
                  </label>
                </div>
              </div>

              <!-- Água radiador -->
              <div>
                <label class="mb-2 block text-lg font-semibold "
                  >Água radiador</label
                >
                <div class="flex flex-wrap gap-2">
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="agua_radiador"
                      value="true"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                    >
                      Nivel Ok
                    </div>
                  </label>
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="agua_radiador"
                      value="false"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-red-500 peer-checked:text-white"
                    >
                      Nivel baixo
                    </div>
                  </label>
                </div>
              </div>

              <!-- Água limpa vidros -->
              <div>
                <label class="mb-2 block text-lg font-semibold "
                  >Água limpa vidros</label
                >
                <div class="flex flex-wrap gap-2">
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="agua_vidros"
                      value="true"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                    >
                      Nivel Ok
                    </div>
                  </label>
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="agua_vidros"
                      value="false"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-red-500 peer-checked:text-white"
                    >
                      Nivel baixo
                    </div>
                  </label>
                </div>
              </div>

              <!-- Triângulo -->
              <div>
                <label class="mb-2 block text-lg font-semibold "
                  >Triângulo</label
                >
                <div class="flex flex-wrap gap-2">
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="triangulo"
                      value="true"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                    >
                      Operacional
                    </div>
                  </label>
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="triangulo"
                      value="false"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-red-500 peer-checked:text-white"
                    >
                      Não Operacional
                    </div>
                  </label>
                </div>
              </div>

              <!-- Pneus -->
              <div>
                <label class="mb-2 block text-lg font-semibold "
                  >Pneus</label
                >
                <div class="flex flex-wrap gap-2">
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="pneus"
                      value="true"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                    >
                      Operacional
                    </div>
                  </label>
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="pneus"
                      value="false"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center 00 peer-checked:bg-red-500 peer-checked:text-white"
                    >
                      Não Operacional
                    </div>
                  </label>
                </div>
              </div>

              <!-- Colete refletor -->
              <div>
                <label class="mb-2 block text-lg font-semibold "
                  >Colete refletor</label
                >
                <div class="flex flex-wrap gap-2">
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="colete"
                      value="true"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                    >
                      Operacional
                    </div>
                  </label>
                  <label
                    class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                  >
                    <input
                      type="radio"
                      name="colete"
                      value="false"
                      class="peer hidden"
                      required
                    />
                    <div
                      class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-red-500 peer-checked:text-white"
                    >
                      Não Operacional
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Combustível -->
          <div class="space-y-4 rounded-md  p-4 shadow-sm">
            <label class="mb-2 block text-lg font-semibold "
              >Combustível</label
            >
            <div class="flex flex-wrap gap-2">
              <!-- Cheio (Green) -->
              <label class="flex-[1_1_45%] cursor-pointer sm:flex-1">
                <input
                  type="radio"
                  name="combustivel"
                  value="5"
                  class="peer hidden"
                />
                <div
                  class="w-full rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                >
                  Cheio
                </div>
              </label>

              <!-- 1/2 (Yellow-green) -->
              <label class="flex-[1_1_45%] cursor-pointer sm:flex-1">
                <input
                  type="radio"
                  name="combustivel"
                  value="4"
                  class="peer hidden"
                />
                <div
                  class="w-full rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-lime-400 peer-checked:text-white"
                >
                  Entre Cheio e 3/4
                </div>
              </label>

              <!-- Quase cheio (Yellow) -->
              <label class="flex-[1_1_45%] cursor-pointer sm:flex-1">
                <input
                  type="radio"
                  name="combustivel"
                  value="3"
                  class="peer hidden"
                />
                <div
                  class="w-full rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-yellow-400 peer-checked:text-black"
                >
                  Entre 3/4 e 1/2
                </div>
              </label>

              <!-- Quase vazio (Orange) -->
              <label class="flex-[1_1_45%] cursor-pointer sm:flex-1">
                <input
                  type="radio"
                  name="combustivel"
                  value="2"
                  class="peer hidden"
                />
                <div
                  class="w-full rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-orange-500 peer-checked:text-white"
                >
                  Entre 1/2 e 1/4
                </div>
              </label>

              <!-- Vazio (Red) -->
              <label class="flex-[1_1_45%] cursor-pointer sm:flex-1">
                <input
                  type="radio"
                  name="combustivel"
                  value="1"
                  class="peer hidden"
                />
                <div
                  class="w-full rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-red-500 peer-checked:text-white"
                >
                  Entre 1/4 e vazio
                </div>
              </label>
            </div>
          </div>

          <!-- Km e revisão -->
          <div class="space-y-4 rounded-md  p-4 shadow-sm">
            <label for="km_viatura" class="text-lg font-semibold"
              >Km da Viatura</label
            >
            <input
              type="number"
              name="km_viatura"
              placeholder="Informe o KM atual"
              class="w-full rounded-md border p-2"
              required
            />

            <label for="revisao" class="block text-lg font-semibold"
              >Revisão</label
            >
            <input
              type="number"
              name="revisao"
              placeholder="Informe a revisão (se aplicável)"
              class="w-full rounded-md border p-2"
            />
          </div>

          <!-- Luzes -->
          <div class="space-y-4 rounded-md  p-4 shadow-sm">
            <h3 class="text-lg font-semibold">Verificação de Luzes</h3>

            <!-- Luzes da Viatura -->
            <div>
              <p class="mb-2 font-medium">Luzes da viatura</p>
              <div class="flex flex-wrap gap-2">
                <label
                  class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                >
                  <input
                    type="radio"
                    name="luzes_viatura"
                    value="true"
                    class="peer hidden"
                    required
                  />
                  <div
                    class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                  >
                    Operacional
                  </div>
                </label>
                <label
                  class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                >
                  <input
                    type="radio"
                    name="luzes_viatura"
                    value="false"
                    class="peer hidden"
                    required
                  />
                  <div
                    class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-red-500 peer-checked:text-white"
                  >
                    Não Operacional
                  </div>
                </label>
              </div>
            </div>

            <!-- Iluminação de Emergência -->
            <div>
              <p class="mb-2 font-medium">Iluminação de emergência</p>
              <div class="flex flex-wrap gap-2">
                <label
                  class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                >
                  <input
                    type="radio"
                    name="iluminacao_emergencia"
                    value="true"
                    class="peer hidden"
                    required
                  />
                  <div
                    class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-green-500 peer-checked:text-white"
                  >
                    Operacional
                  </div>
                </label>
                <label
                  class="flex flex-[1_1_45%] cursor-pointer items-stretch sm:flex-1"
                >
                  <input
                    type="radio"
                    name="iluminacao_emergencia"
                    value="false"
                    class="peer hidden"
                    required
                  />
                  <div
                    class="flex w-full items-center justify-center rounded-md border border-gray-300 px-4 py-2 text-center  peer-checked:bg-red-500 peer-checked:text-white"
                  >
                    Não Operacional
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Avaria -->
          <div class="rounded-md  p-4 shadow-sm">
            <h3 class="text-lg font-semibold">Reportar Avaria</h3>
            <textarea
              name="avaria"
              placeholder="Descreva qualquer avaria..."
              class="h-32 w-full rounded-md border p-2"></textarea>
          </div>

          <!-- Botão enviar checklist-->
          <div class="mt-8 flex justify-center">
            <button type="submit" class="button color-third">
              Validar Checklist
            </button>
          </div>
        </form>
      </section>

      <div
        id="result-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      >
        <div class="max-w-md rounded-lg  p-6 shadow-lg">
          <h2 class="mb-4 text-xl font-bold">Resultado da Verificação</h2>
          <p id="modal-message" class="mb-4 text-gray-700"></p>
          <button
            onclick="document.getElementById('result-modal').classList.add('hidden')"
            class="rounded bg-blue-600 px-4 py-2 text-white"
          >
            Fechar
          </button>
        </div>
      </div>

      <!-- Torna o array viaturas disponível no JS do browser -->
      <!-- <script>
        window.viaturas = JSON.parse('{JSON.stringify(viaturas)}');
      </script> -->

      <script type="module">
        // Função para obter o tipo de óleo da viatura selecionada
        function getTipoOleo(viaturaName) {
          const viaturasData = Array.isArray(window.viaturas) ? window.viaturas : [];
          // Procura por name ou plate
          const viatura = viaturasData.find(
            v => v.name === viaturaName || v.plate === viaturaName
          );
          return viatura && viatura.oleo ? viatura.oleo : "óleo recomendado";
        }

        const form = document.getElementById("checklist-form");
        const viaturaInput = document.getElementById("viatura-input");
        document.querySelectorAll('[data-astro-cid][data-astro-props]').forEach(card => {
          card.addEventListener('click', () => {
            const props = JSON.parse(card.getAttribute('data-astro-props'));
            viaturaInput.value = props.name;
            // ...highlight...
          });
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = new FormData(form);

          // Valores individuais
          const combustivelValor = Number(data.get("combustivel"));

          const payload = {
            operacional: Number(data.get("operacional")),
            pin: String(data.get("pin") || "").trim(),
            viatura: data.get("viatura-input"),
            oleo: data.get("oleo") === "true",
            agua_radiador: data.get("agua_radiador") === "true",
            agua_vidros: data.get("agua_vidros") === "true",
            triangulo: data.get("triangulo") === "true",
            pneus: data.get("pneus") === "true",
            colete: data.get("colete") === "true",
            combustivel: combustivelValor,
            km_viatura: Number(data.get("km_viatura")),
            revisao: data.get("revisao") ? Number(data.get("revisao")) : null,
            luzes_viatura: data.get("luzes_viatura") === "true",
            iluminacao_emergencia: data.get("iluminacao_emergencia") === "true",
            avaria: data.get("avaria") || "",
          };

          if (!payload.viatura) {
            showModal("Por favor, selecione uma viatura.");
            return;
          }

          const res = await fetch("/api/checklist", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const json = await res.json();

          if (json.success) {
            // Criar lista de problemas detetados
            const problemas = [];
            if (combustivelValor <= 3) problemas.push("combustível abaixo de 3/4");
            if (!payload.agua_radiador) problemas.push("água no radiador");
            if (!payload.agua_vidros) problemas.push("água do limpa-vidros");
            if (!payload.triangulo) problemas.push("triângulo de sinalização");
            if (!payload.pneus) problemas.push("pressão/estado dos pneus");
            if (!payload.colete) problemas.push("colete refletor");
            if (!payload.luzes_viatura) problemas.push("luzes da viatura");
            if (!payload.iluminacao_emergencia) problemas.push("iluminação de emergência");
            if (!payload.oleo) {
              const tipoOleo = getTipoOleo(payload.viatura);
              problemas.push(`nível de óleo — usar ${tipoOleo}`);
            };

            const mensagemBase = "Checklist enviado com sucesso!";
            const mensagemProblemas = problemas.length
              ? `<br><strong>Atenção:</strong><ul>${problemas.map((p) => `<li>${p}</li>`).join("")}</ul>`
              : "";

            showModal(`${mensagemBase}${mensagemProblemas}`);
            form.reset();
            // Limpa seleção de viatura
            document.querySelectorAll('[data-astro-cid][data-astro-props]').forEach(c => c.classList.remove('ring-2', 'ring-blue-500'));
          } else {
            showModal(json.error || "Erro ao enviar checklist.");
          }
        });

        // Função para mostrar a modal reutilizável
        function showModal(html) {
          const modal = document.getElementById("result-modal");
          const mensagem = document.getElementById("modal-message");
          mensagem.innerHTML = html;
          modal.classList.remove("hidden");
        }
      </script>
    </div>
  </section>
</DefaultLayout>
