---
// src/pages/noticias/index.astro
import { Card } from "accessible-astro-components";
import DefaultLayout from "../../layouts/DefaultLayout.astro";
import { getArticles } from "../../lib/strapi";

const STRAPI_URL = import.meta.env.STRAPI_URL || "https://cms.albarinolab.pt";

// Fetch articles from Strapi
const { data: articles } = await getArticles();

// Filter and sort articles
const now = new Date();
const visiblePosts = articles
  .filter((article) => {
    const publishDate = new Date(article.publishedAt);
    return publishDate <= now;
  })
  .sort((a, b) => {
    const dateA = new Date(a.publishedAt);
    const dateB = new Date(b.publishedAt);
    return dateB.getTime() - dateA.getTime();
  });
---

<DefaultLayout title="Atualizações" description="Ultimas atualizações">
  <section class="my-20">
    <div class="space-content container">
      <h1>Atualizações</h1>
      <p class="text-2xl">Ultimas atualizações</p>
    </div>
  </section>

  <section class="my-12">
    <div class="container">
      <ul class="my-3">
        {visiblePosts.length === 0 && <p>No posts available</p>}

        {
          visiblePosts.map((article) => (
            <li>
              <Card
                url={"/noticias/" + article.slug}
                title={article.title}
                footer={
                  "Atualizado a: " +
                  new Date(article.publishedAt).toLocaleDateString("pt-PT", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })
                }
                img={
                  article.cover
                    ? STRAPI_URL + article.cover.url
                    : "/default-image.jpg"
                }
              >
                <p>{article.description}</p>
              </Card>
            </li>
          ))
        }
      </ul>
    </div>
  </section>
</DefaultLayout>

<style lang="scss">
  ul {
    display: grid;
    grid-template-columns: 1fr;
    grid-gap: 4rem;

    @media (min-width: 550px) {
      grid-template-columns: repeat(2, 1fr);
      grid-gap: 2rem;
    }

    @media (min-width: 950px) {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
